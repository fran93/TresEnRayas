<!DOCTYPE html>
<html>
    <head>
        <% include headerStuff %>
    </head>
    <body>
        
        <% include header %>
        
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-4">  
                    <div class="panel panel-primary"> 
                        <div class="panel-heading"> 
                            <h3 class="panel-title"> Lista de usuarios </h3> 
                        </div> 
                        <div class="panel-body">  
                            <div id='userList' class="list-group"> </div>
                        </div> 
                    </div>
                </div>     
                <div class="col-lg-4">  
                    <div class="panel panel-default">
                        <!-- Default panel contents -->
                        <div class="panel-heading">Estadísticas de <span class="badge"><%= user %></span> </div>

                        <!-- Table -->
                        <table class="table">
                            <tr>
                                <th scope="row">Partidas jugadas</th>
                                <td>0</td>
                            </tr>
                            <tr>
                                <th scope="row">Partidas ganadas</th>
                                <td>0</td>
                            </tr>
                            <tr>
                                <th scope="row">Partidas empatadas</th>
                                <td>0</td>
                            </tr>
                            <tr>
                                <th scope="row">Partidas perdidas</th>
                                <td>0</td>
                            </tr>
                            <tr>
                                <th scope="row">Porcentaje de victorias</th>
                                <td>0%</td>
                            </tr>
                        </table>
                    </div>
                    
                    <button id="letsplay" class="btn btn-primary" type="button">Jugar vs <span class="badge"><%= user %></span></button>
                </div>
                
                <div class="col-lg-4">
                    <div id="challenge" class="modal-content" style="display: none;"> 
                        <div class="modal-header"> 
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button> 
                            <h4 class="modal-title">¡Has sido retado!</h4> 
                        </div> 
                        <div class="modal-body"> 
                            <p> ¡<span class='badge'>  </span> te ha retado! ¿Aceptas jugar contra él?</p> 
                        </div> 
                        <div class="modal-footer"> 
                            <button type="button" class="btn btn-danger">Rechazar</button> 
                            <button type="button" class="btn btn-success">Aceptar</button> 
                        </div> 
                    </div>
                    
                    <div class="alert alert-info" role="alert"  style="display: none;"> <strong>Esperando</strong> a que acepte la petición el otro jugador.</div>
                </div>
            </div>
        </div>
        
        <% include footer %>
        
        <script src="/socket.io/socket.io.js"></script>
        <script> 
            $( document ).ready(function() {
                var socket = io('/home');
                //el usuario que está viendo la interfaz
                var mainUser='<%= user %>';
                //el usuario seleccionado en la lista
                var selectedUser = '<%= user %>';

                //Resfrescar la lista de usuarios
                socket.on('usersList', function (users) {
                    $('#userList').empty();
                    for (var i = 0; i < users.length; i++) {
                        $('#userList').append('<button type="button" class="list-group-item">' + users[i] + '</button>');
                    }
                    $('#userList button').click(function(){
                        loadStats($(this).text());
                    });
                });
                
                //Comprobar si alguien nos ha retado
                socket.on('challenge', function(user){
                    $('#challenge span.badge').text(user);
                    $('#challenge').show();
                });
                
                //Respuesta al reto
                socket.on('responseChallenge', function(json){
                    if(json.accepted){
                        window.location.href = "/tablero?rival="+json.rival;
                    }else{
                        $('.alert-info').hide();
                    }
                });
                
                //Aceptar el reto
                $('#challenge .btn-success').click(function(){
                    var rival = $('#challenge span.badge').text();
                    $('#challenge').hide();
                    socket.emit('responseChallenge', {user: rival, accepted: true});
                    window.location.href = "/tablero?rival="+rival;
                });
                //Rechazar el reto
                $('#challenge .btn-danger').click(function(){
                    $('#challenge').hide();
                    socket.emit('responseChallenge', {user: $('#challenge span.badge').text(), accepted: false});
                });
                
                $('#letsplay').click(function(){
                    if(mainUser===selectedUser){
                        window.location.href = "/bot";
                    }else{
                        $('.alert-info').show();
                        socket.emit('challenge', selectedUser);
                    }
                });
                
                //Cargar las estadísticas del usuario
                loadStats(mainUser);
                
                function loadStats(user){
                    //cambiar el usuario seleccionado
                    selectedUser = user;
                    //pedir los datos al servidor
                    socket.emit('statistics', user);
                    //cambiar el nombre 
                    $('.panel-heading span.badge').text(user);
                    $('#letsplay span.badge').text(user);
                }
                
                socket.on('statistics', function(result){
                    if(result===null){
                        //actualizar los datos de las estadísticas
                        $('td:eq(0)').text(0);
                        $('td:eq(1)').text(0);
                        $('td:eq(2)').text(0);
                        $('td:eq(3)').text(0);
                        $('td:eq(4)').text('0%');
                    }else{
                        //actualizar los datos de las estadísticas
                        $('td:eq(0)').text(result.played);
                        $('td:eq(1)').text(result.victories);
                        $('td:eq(2)').text(result.tables);
                        $('td:eq(3)').text(result.defeats);
                        //calcular el porcentaje de victorias
                        var porcentaje = (result.victories/result.played)*100;
                        $('td:eq(4)').text(porcentaje+'%');
                    }
                });
            });

        </script>
        
    </body>
</html>
